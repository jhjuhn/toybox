<!DOCTYPE HTML>
<html>
<head>
<link href = 'https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel = 'stylesheet' type = 'text/css'>
<style>
html, body {
	margin: 0; padding: 0;
	background-color: #fff;
	color: #999;

	font-family: 'open sans', sans-serif;
	font-size: 14px;
}
h2 { font-size: 18px; }

/*UI*/

#container {
	width: 720px;
	margin: 4px auto;
}
#credits{
	margin-top: 16px;
	font-size: 12px;
}

/* WORLD*/

#world {
	border: 1px #ccc none;/*dashed;*/

	margin: 4px auto;

	position: relative;

	width: 720px;
	height: 720px;

	/*overflow: hidden;*/
}

</style>

<script src = "../shared/three.min.js"></script>
<script>

function integrate(q, v){
	q[0] = q[0]+v[0]*dt;
	q[1] = q[1]+v[1]*dt;
	q[2] = q[2]+v[2]*dt;
}

var max_time = 1048576;
var dt = 0.002;
function Lorenz(){

	// parameters
	this.sig = 10;
	this.bet = 8/3;
	this.rho = 28;

	// system state
	this.q = [1, 0, 0];
	this.v = [-10, 0, 0];

	this.age = 0;


	// THREE.js thingies
	var g = new THREE.BufferGeometry();
	g.addAttribute('position',
	new THREE.BufferAttribute(
		new Float32Array(max_time*3),
		3));
	g.getAttribute('position').dynamic = true;

	this.steps_per_seg = 4;
	this.segs_per_update = 12;

	var m = new THREE.LineBasicMaterial({
		color: 0x000000, linewidth: 1});

	this.mesh = new THREE.Line(g, m);

	
	return this;
}
Lorenz.prototype.update = function(){
	for (var j = 0; j < this.segs_per_update; ++j) {

	var qpattr = this.mesh.geometry.getAttribute('position');
	var qarray = qpattr.array;

	// update location of traced particle
	for (var i = 0; i < this.steps_per_seg; ++i) {
		this.v = [
			this.sig*(this.q[1]-this.q[0]),
			this.q[0]*(this.rho-this.q[2])-this.q[1],
			this.q[0]*this.q[1]-this.bet*this.q[2]
		];
		integrate(this.q, this.v);
	}

	// push a new vertice
	qarray[this.age*3  ] = this.q[0];
	qarray[this.age*3+1] = this.q[1];
	qarray[this.age*3+2] = this.q[2];
	
	qpattr.needsUpdate = true;
	this.mesh.geometry.setDrawRange(0, this.age);

	++this.age;

	}
}

var renderer, camera, scene;
var origin = new THREE.Vector3(0, 0, 0);

var lorenz;

function init(){
	// set up renderer, camera, and scene
	renderer = new THREE.WebGLRenderer({
		canvas: document.getElementById("world"),
		antialias: true
	});
	renderer.setClearColor(0xcccccc);

	camera = new THREE.PerspectiveCamera(45,
		renderer.domElement.clientHeight/
		renderer.domElement.clientWidth,
		10, 1000);

	camera.up.set(0, 0, 1);
	scene = new THREE.Scene();

	// origin cube, for reference.
	var c = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.1), 
		new THREE.MeshBasicMaterial({color: 0xffffff}));
	scene.add(c);

	// drawr some lines
	lines([0, 0, 0], [1, 0, 0], 0xff0000);
	lines([0, 0, 0], [0, 1, 0], 0x00ff00);
	lines([0, 0, 0], [0, 0, 1], 0x0000ff);

	lorenz = new Lorenz();
	scene.add(lorenz.mesh);

	// start timestepping
	timestep();

}

function lines(a, b, c){
	
	
	var m = new THREE.LineBasicMaterial({color: c, linewidth: 2});
	var g = new THREE.Geometry();
	g.vertices.push(new THREE.Vector3(a[0], a[1], a[2]));
	g.vertices.push(new THREE.Vector3(b[0], b[1], b[2]));

	var l = new THREE.Line(g, m);
	
	scene.add(l);
}

var t = 0;
function timestep(){
	t = t + dt;

	lorenz.update();


	// update camera setup
	camera.position.set(100*Math.cos(t), 100*Math.sin(t), 120);
	camera.lookAt(origin);

	renderer.render(scene, camera);

	window.requestAnimationFrame(timestep);
}


</script>

</head>
<body>

<div id = "container">
	<h2>TITLE</h2>

	<canvas id = "world" width = "720" height = "720"></canvas>
	<script> init(); </script>
	
	<div><p>description.</p></div>

	<div id = "credits">
	J. Lok, [M] [yyyy].
	</div>

</div>


</body>

</html>
