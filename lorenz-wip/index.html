<!DOCTYPE HTML>
<html>
<head>
<link href = 'https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel = 'stylesheet' type = 'text/css'>
<style>
html, body {
	margin: 0; padding: 0;
	background-color: #fff;
	color: #999;

	font-family: 'open sans', sans-serif;
	font-size: 14px;
}
h2 { font-size: 18px; }

/*UI*/

#container {
	width: 720px;
	margin: 4px auto;
}
#credits{
	margin-top: 16px;
	font-size: 12px;
}

/* WORLD*/

#world {
	border: 1px #ccc dashed;

	margin: 4px auto;

	position: relative;

	width: 512px;
	height: 512px;

	/*overflow: hidden;*/
}

</style>

<!-- computation -->
<script id = "texvert" type = "notjs">
attribute vec4 vertq;
void main() { gl_Position = vertq; }
</script>
<script id = "texfrag" type = "notjs">
precision highp float;

uniform sampler2D tex;

float SQN = 128.;
float TEXSIZE = 512.0;
float DT = 0.002;

vec4 Roessler(vec4 q) {
	float A = 0.2, B = 0.2, C = 5.7;
	return vec4(
		-q.y-q.z,
		q.x+A*q.y,
		B+q.z*(q.x-C),
		1
	);
}

void main(){
	
	vec2 uv = gl_FragCoord.xy/TEXSIZE;
	float dx = 1.0/TEXSIZE;
	vec4 q, v;

	//gl_FragColor = vec4(q, 0, 1);

	if (gl_FragCoord.x > SQN && gl_FragCoord.x < 2.*SQN && gl_FragCoord.y <= SQN) {
		// velocity pixel
		q = texture2D(tex, uv-vec2(SQN/TEXSIZE, 0));
		v = texture2D(tex, uv);

		//gl_FragColor = v+q;
		
		gl_FragColor = Roessler(q);

	} else if (gl_FragCoord.x < SQN && gl_FragCoord.y <= SQN){
		// location pixel
		q = texture2D(tex, uv);
		v = texture2D(tex, uv+vec2(SQN/TEXSIZE, 0));

		vec4 nv = Roessler(q);

		gl_FragColor = q+nv*DT;

	} else {
		gl_FragColor = vec4(0, 0, 0, 1);
	}
}
</script>


<!-- visualisation -->
<script id = "visvert" type = "notjs">
attribute vec4 partq;
uniform sampler2D data;

varying vec4 q;

float TEXSIZE = 512.;
void main(){

	vec2 uv = (partq.xy+1.)/2./TEXSIZE;
	
	q = texture2D(data, uv);

	gl_PointSize = 1.;
	gl_Position = vec4(q.xy/120., 0, 1);
}
</script>
<script id = "visfrag", type = "notjs">
precision highp float;

varying vec4 q;

void main(){
	float z = (q.z+1.);
	gl_FragColor = vec4(0, 0, 0, z);
}
</script>
<script>

var canvas;
var context;

var texprog;

var texA;
var fbuffA;
var texB;
var fbuffB;

var vertqbuff;
var vertqloc;
var partqbuff;
var partqloc;

var texloc;

var visprog;
var dataloc;

var sqN = 128;
var L = 512;

function initGL(){
	canvas = document.getElementById("world");
	context = canvas.getContext("webgl");
	context.getExtension('OES_texture_float');

	var texvert = createShader(context.VERTEX_SHADER,
		document.getElementById("texvert").text);
	var texfrag = createShader(context.FRAGMENT_SHADER,
		document.getElementById("texfrag").text);

	texprog = createProgram(texvert, texfrag);


	var visvert = createShader(context.VERTEX_SHADER,
		document.getElementById("visvert").text);
	var visfrag = createShader(context.FRAGMENT_SHADER,
		document.getElementById("visfrag").text);

	visprog = createProgram(visvert, visfrag);


	// setup textures and framebuffers for tex
	initSquare();

	texA = setupTexture(null);
	fbuffA = setupfBuffer(texA);

	texB = setupTexture(texgen());
	fbuffB = setupfBuffer(texB);

	texloc = context.getUniformLocation(texprog, "tex");

	// setup texture for vis
	initParticles();	

	dataloc = context.getUniformLocation(visprog, "data");

	//context.useProgram(null);

	timestep();

	
}

var iter = 1;
function timestep(){

	context.bindBuffer(context.ARRAY_BUFFER, partqbuff);
	for (var i = 0; i < iter; ++i) {
		swapBuffers();
		texdrawr();
	}

	context.bindFramebuffer(context.FRAMEBUFFER, null);

	visdrawr();

	window.requestAnimationFrame(timestep);

}

function texdrawr(){
	context.useProgram(texprog);

	context.bindBuffer(context.ARRAY_BUFFER, vertqbuff);
	context.vertexAttribPointer(vertqloc, 2,
			context.FLOAT, false, 0, 0);

	context.clear(context.COLOR_BUFFER_BIT);
	context.viewport(0, 0, L, L);
	context.drawArrays(context.TRIANGLE_STRIP, 0, 4);

	context.bindBuffer(context.ARRAY_BUFFER, null);
	//context.useProgram(null);
}
function visdrawr(){
	context.useProgram(visprog);

	context.bindBuffer(context.ARRAY_BUFFER, partqbuff);
	context.vertexAttribPointer(partqloc, 2,
			context.FLOAT, false, 0, 0);
	
	context.activeTexture(context.TEXTURE0);
	context.bindTexture(context.TEXTURE_2D, texA);
	context.uniform1i(dataloc, 0);

	context.clear(context.COLOR_BUFFER_BIT);
	context.viewport(0, 0, L, L);
	//context.drawArrays(context.TRIANGLE_STRIP, 0, sqN*sqN);
	context.drawArrays(context.POINTS, 0, sqN*sqN);

	context.bindBuffer(context.ARRAY_BUFFER, null);
}

function setupTexture(data){
	context.useProgram(texprog);
	context.activeTexture(context.TEXTURE0);

	var tex = context.createTexture();
	context.bindTexture(context.TEXTURE_2D, tex);
	context.texImage2D(context.TEXTURE_2D, 0, context.RGBA,
					 L, L, 0, context.RGBA,
					 context.FLOAT, data);
	context.texParameteri(context.TEXTURE_2D, context.TEXTURE_WRAP_S, context.REPEAT);
	context.texParameteri(context.TEXTURE_2D, context.TEXTURE_WRAP_T, context.REPEAT);
	context.texParameteri(context.TEXTURE_2D, context.TEXTURE_MAG_FILTER, context.NEAREST);
	context.texParameteri(context.TEXTURE_2D, context.TEXTURE_MIN_FILTER, context.NEAREST);

	context.bindTexture(context.TEXTURE_2D, null);

	context.useProgram(null);
	return tex;
}

var renderA = false;
function swapBuffers(){
	context.useProgram(texprog);

	renderA = !renderA;
	if (renderA) { // read from B render to A
		context.bindFramebuffer(context.FRAMEBUFFER, fbuffA);
		context.bindTexture(context.TEXTURE_2D, texB);
		context.uniform1i(texloc, 0);
	} else {
		context.bindFramebuffer(context.FRAMEBUFFER, fbuffB);
		context.bindTexture(context.TEXTURE_2D, texA);
		context.uniform1i(texloc, 0);
	}
	//context.useProgram(null);
}

function setupfBuffer(tex){
		
	var fbuff = context.createFramebuffer();
	context.bindFramebuffer(context.FRAMEBUFFER, fbuff);
	context.framebufferTexture2D(context.FRAMEBUFFER, context.COLOR_ATTACHMENT0,
					context.TEXTURE_2D, tex, 0);
	context.bindFramebuffer(context.FRAMEBUFFER, null);
	return fbuff;
}



function texgen(){
	var t = [];
	for (var i = 0; i < 4*L*L; ++i) { t[i] = 0; }

	var range = 80;
	
	for(var i = 0; i < sqN; ++i){
	for(var j = 0; j < sqN; ++j){
		// locations
		t[4*(j*L+i)  ] = range*(Math.random()*2-1);
		t[4*(j*L+i)+1] = range*(Math.random()*2-1);
		t[4*(j*L+i)+2] = range*(Math.random()*2-1);
		t[4*(j*L+i)+3] = 1;
		// velocities
		t[4*(j*L+i+sqN)  ] = 0;//0.005*(Math.random()*2-1);
		t[4*(j*L+i+sqN)+1] = 0;//0.005*(Math.random()*2-1);
		t[4*(j*L+i+sqN)+2] = 0;//0.005*(Math.random()*2-1);
		t[4*(j*L+i+sqN)+3] = 1;
	}}
	
	
	return new Float32Array(t);

}

function initParticles(){
	context.useProgram(visprog);
	partqbuff = context.createBuffer();
	partqloc = context.getAttribLocation(visprog, "partq");
	
	context.bindBuffer(context.ARRAY_BUFFER, partqbuff);

		
	var partq = [];
	for (var i = 0; i < sqN; ++i) {
	for (var j = 0; j < sqN; ++j) {
		partq[2*(j*sqN+i)  ] = i;
		partq[2*(j*sqN+i)+1] = j;
	}}
	
	context.bufferData(context.ARRAY_BUFFER,
		new Float32Array(partq),
		context.STATIC_DRAW);
	context.enableVertexAttribArray(partqloc);
	context.vertexAttribPointer(partqloc, 2,
		context.FLOAT, false, 0, 0);

	/*
	context.bindBuffer(context.ARRAY_BUFFER, null);
	*/
}

function initSquare(){
	context.useProgram(texprog);
	vertqbuff = context.createBuffer();
	vertqloc  = context.getAttribLocation(texprog, "vertq");
	context.bindBuffer(context.ARRAY_BUFFER, vertqbuff);

	var squareq = [
		1, 1,
		1, -1,
		-1, 1,
		-1, -1
		];

	context.bufferData(context.ARRAY_BUFFER,
			new Float32Array(squareq),
			context.STATIC_DRAW);

	context.enableVertexAttribArray(vertqloc);
	context.vertexAttribPointer(vertqloc, 2,
			context.FLOAT, false, 0, 0);

	context.bindBuffer(context.ARRAY_BUFFER, null);
}

function createShader(type, source){
	var shader = context.createShader(type);
	context.shaderSource(shader, source);
	context.compileShader(shader);
	console.log(context.getShaderInfoLog(shader));
	return shader;
}

function createProgram(vertshader, fragshader){
	var program = context.createProgram();
	context.attachShader(program, vertshader);
	context.attachShader(program, fragshader);
	context.linkProgram(program);

	console.log(context.getProgramInfoLog(program));
	return program;
}


</script>

</head>
<body>

<div id = "container">
	<h2>TITLE</h2>

	<canvas id = "world" width = "512" height = "512"></canvas>
	<script> initGL(); </script>
	
	<div><p>description.</p></div>

	<div id = "credits">
	J. Lok, [M] [yyyy].
	</div>

</div>


</body>

</html>
