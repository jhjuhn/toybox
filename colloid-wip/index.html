<!DOCTYPE HTML>
<html>
<head>
<link href = 'https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel = 'stylesheet' type = 'text/css'>
<style>
html, body {
	margin: 0; padding: 0;
	background-color: #fff;
	color: #999;

	font-family: 'open sans', sans-serif;
	font-size: 14px;
}
h2 { font-size: 18px; }

/*UI*/

#container {
	width: 720px;
	margin: 4px auto;
}
#credits{
	margin-top: 16px;
	font-size: 12px;
}

/* WORLD*/

#world {
	border: 1px #ccc none;/*dashed;*/

	margin: 4px auto;

	position: relative;

	width: 720px;
	height: 720px;

	overflow: hidden;
}

.particle {
	position: absolute;
	/*border: 1px solid #000000;*/
	background-color: #666;
	width: 16px;
	height: 16px;
	border-radius: 16px;
}
.p-magnetic {
	background-color: #f66;
}

</style>

</head>
<body>

<div id = "container">
	<h2>TITLE</h2>

	<div id = "world" width = "720" height = "720"></div>
	<script src = "../shared/v4.js"></script>
	<script src = "../shared/spash.js"></script>
	<script>
const Particle = function (params) {
	this.q = [ params.x, params.y, 0, 1 ];
	this.q_prev = this.q.v4clone();
	this.a = [ 0, 0, 0, 1 ];

	this.m = params.m;
}
Particle.prototype.integrate = function (dt) {
	let old_q = this.q.v4clone();
	this.q.v4mul(2).v4sub(this.q_prev)
		.v4add(this.a.v4mul(dt*dt/2));
	this.q_prev = old_q;

	/* ad-hoc clamp */
	this.q[0] = Math.max(0, Math.min(this.q[0], 720));
	this.q[1] = Math.max(0, Math.min(this.q[1], 720));
}
Particle.prototype.initVisual = function (ref) {
	const div = document.createElement("div");
	div.classList.add("particle");
	if (this.m > 0) {
		div.classList.add("p-magnetic");
	}
	ref.appendChild(div);

	this.visual = div;
}
Particle.prototype.syncVisual = function () {
	const div = this.visual;
	if (!div) { return; }

	const c = 1;//Math.cos(this.theta);
	const s = 0;//Math.sin(this.theta);
	const w = 8;

	div.style.transform = "matrix(" +
	c + "," + (-s) + "," +
	s + "," +   c  + "," +
	(this.q[0]-w) + "," + (this.q[1]-w) + ")";
}

const Lab = function (params) {
	this.H = params.H;
	this.T = params.T;
	this.particles = [];
	this.ref = params.ref;
	this.dt = 0.2;
}
Lab.prototype.addParticle = function (params) {
	const p = new Particle(params);
	p.initVisual(this.ref);

	this.particles.push(p);
}
Lab.prototype.forces = function () {
	for (let i = 0; i < this.particles.length; ++i) {
		this.particles[i].a.v4set(0, 0, 0);
	}
	/* brownian */
	for (let i = 0; i < this.particles.length; ++i) {
		const th = Math.random()*Math.PI*2;
		this.particles[i].a =
			[ this.T*Math.cos(th), this.T*Math.sin(th), 0, 1];
	}
	/* dipole-dipole */
	function dforces (H, pa, pb) {
		const ma = v4mul(pa.m, H);
		const mb = v4mul(pb.m, H);
		const r = v4sub(pb.q, pa.q);
		const d = v4mag(r);

		const c = 1e4;
		
		const F = v4mul(c/Math.pow(d, 5),
		v4mul(v4dot(ma, r), mb).v4add(
		v4mul(v4dot(mb, r), ma)).v4add(
		v4mul(v4dot(ma, mb), r)).v4sub(
		v4mul(
			5*v4dot(ma, r)*v4dot(mb, r)/d/d,
			r)));

		F[2] = 0;
		pa.a.v4sub(F);
		pb.a.v4add(F);

	}

	let s = new Spash(720, 32);

	for (let i = 0; i < this.particles.length; ++i) {
		s.insert(
			this.particles[i].q[0],
			this.particles[i].q[1],
			i);
	}
	for (let i = 0; i < this.particles.length; ++i) {
		let nhb = s.lookup(
			this.particles[i].q[0],
			this.particles[i].q[1]);
		for (let j in nhb) {
			if (i < j) {
				dforces(
				this.H,
				this.particles[i],
				this.particles[j]);
			}
		}
	}

	/*
	for (let i = 0; i < this.particles.length; ++i) {
	for (let j = i+1; j < this.particles.length; ++j) {
		dforces(
			this.H,
			this.particles[i],
			this.particles[j]);
	}}
	*/
}
Lab.prototype.constraints = function () {
	function constrain (pa, pb) {
		const u = v4sub(pb.q, pa.q);
		const d = u.v4mag();
		const offset = (16-d)/2;
		if (offset <= 0) { return; }

		pa.q.v4sub(v4mul(offset/d, u));
		pb.q.v4add(v4mul(offset/d, u));

	}

	let s = new Spash(720, 16);

	for (let i = 0; i < this.particles.length; ++i) {
		s.insert(
			this.particles[i].q[0],
			this.particles[i].q[1],
			i);
	}
	for (let i = 0; i < this.particles.length; ++i) {
		let nhb = s.lookup(
			this.particles[i].q[0],
			this.particles[i].q[1]);
		for (let j in nhb) {
			if (i < j) {
				constrain(
				this.particles[i],
				this.particles[j]);
			}
		}
	}

	/*
	for (let i = 0; i < this.particles.length; ++i) {
	for (let j = i+1; j < this.particles.length; ++j) {
		constrain(
			this.particles[i],
			this.particles[j]);
	}}
	*/
}

Lab.prototype.integrate = function () {
	for (let i = 0; i < this.particles.length; ++i) {
		this.particles[i].integrate(this.dt);
	}
}
Lab.prototype.render = function () {
	for (let i = 0; i < this.particles.length; ++i) {
		this.particles[i].syncVisual();
	}
}
Lab.prototype.timestep = function () {
	window.requestAnimationFrame(this.timestep.bind(this));
	this.forces();
	this.integrate();	
	this.constraints();
	this.constraints();
	this.render();
}



const l = new Lab({
	ref: document.getElementById("world"),
	H: [ 0, 0, 2, 1 ],
	T: 1
});
const w = 20;
for (let i = 0; i < 720/w; ++i) {
for (let j = 0; j < 720/w; ++j) {
	l.addParticle({
		x: w*i,
		y: w*j,
		theta: 3.14*Math.random(),
		m: Math.random() > 0.5 ? 1 : -1
	});
}}
l.timestep();

	</script>	
	<div><p>description.</p></div>

	<div id = "credits">
	J. Lo, [M] [yyyy].
	</div>

</div>

</body>
</html>
