<!DOCTYPE HTML>
<html>
<head>
<link href = 'https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel = 'stylesheet' type = 'text/css'>
<style>
html, body {
	margin: 0; padding: 0;
	background-color: #fff;
	color: #999;

	font-family: 'open sans', sans-serif;
	font-size: 14px;
}
h2 { font-size: 18px; }

/*UI*/

#container {
	width: 720px;
	margin: 4px auto;
}
#credits{
	margin-top: 16px;
	font-size: 12px;
}

/* WORLD*/

#world {
	border: 1px #ccc dashed;

	margin: 4px auto;

	position: relative;

	width: 720px;
	height: 720px;

	/*overflow: hidden;*/
}

</style>
<script>
// v4.js
Array.prototype.v4clone = function(u){ return [u[0], u[1], u[2], 1]; }

function v4dot(u, v){ return u[0]*v[0]+u[1]*v[1]+u[2]*v[2]; }
function v4mul(a, v){ return (v[0]!==undefined)?[a*v[0], a*v[1], a*v[2], 1]:v4mul(v, a); }
Array.prototype.v4mul = function(a){
	this[0]*=a; this[1]*=a; this[2]*=a; return this; }

function v4x(u, v){ return [
	u[1]*v[2]-v[1]*u[2],
	u[2]*v[0]-v[2]*u[0],
	u[0]*v[1]-v[0]*u[1], 1]; }

function v4add(u, v){ return [u[0]+v[0], u[1]+v[1], u[2]+v[2], 1]; }
Array.prototype.v4add = function(v){
	this[0]+=v[0]; this[1]+=v[1]; this[2]+=v[2]; return this; }

function v4sub(u, v){ return [u[0]-v[0], u[1]-v[1], u[2]-v[2], 1]; }
Array.prototype.v4add = function(v){
	this[0]-=v[0]; this[1]-=v[1]; this[2]-=v[2]; return this; }

function v4mag2(u){ return u[0]*u[0]+u[1]*u[1]+u[2]*u[2]; }
Array.prototype.v4mag2 = function(){
	return this[0]*this[0]+this[1]*this[1]+this[2]*this[2]; }

function v4mag(u){ return Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]); }
Array.prototype.v4mag = function(){
	return Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]); }

function v4unit(u){ return v4mul(1/v4mag(u), u); }
Array.prototype.v4unit = function(){
	return this.v4mul(1/this.mag()); }

function mat4id(){
	return [[1, 0, 0, 0],
		[0, 1, 0, 0],
		[0, 0, 1, 0],
		[0, 0, 0, 1]]; }

function mat4mul(A, B){
	var ret = [[],[],[],[]];
	for (var i = 0; i < 4; ++i) {
	for (var j = 0; j < 4; ++j) { ret[i][j] = 0; 
	for (var k = 0; k < 4; ++k) {
		ret[i][j]+=A[i][k]*B[k][j];
	}}}
	return ret;
}

function mat4apply(m, u){
	return [m[0][0]*u[0]+m[0][1]*u[1]+m[0][2]*u[2]+m[0][3]*u[3],
		m[1][0]*u[0]+m[1][1]*u[1]+m[1][2]*u[2]+m[1][3]*u[3],
		m[2][0]*u[0]+m[2][1]*u[1]+m[2][2]*u[2]+m[2][3]*u[3],
		m[3][0]*u[0]+m[3][1]*u[1]+m[3][2]*u[2]+m[3][3]*u[3]];
}

function mat4fromZYZ(e, r){
	var c1 = Math.cos(e.alf); var s1 = Math.sin(e.alf);
	var c2 = Math.cos(e.bet); var s2 = Math.sin(e.bet);
	var c3 = Math.cos(e.gam); var s3 = Math.sin(e.gam);
	if (!r) { r = [0, 0, 0, 1]; }
	return [[c1*c2*c3-s1*s3, -c3*s1-c1*c2*s3, c1*s2, r[0]],
		[c1*s3+c2*c3*s1,  c1*c3-c2*s1*s3, s1*s2, r[1]],
		[        -c3*s2,           s2*s3,    c2, r[2]],
		[             0,               0,     0,   1]];
}

function ZYZ(a, b, g){ return {alf: a, bet: b, gam: g};}
function ZYZclone(e){ return {alf: e.alf, bet: e.bet, gam: e.gam};}

</script>
<script>
// Lindenmayer
function node(c, a, b, g, l){
	this.ch = c;
	this.alf = a;
	this.bet = b;
	this.gam = g;
	this.len = l;
}

var lindenmayer = [];
function init(){

	lindenmayer[0] = new node('F', 0, 0, 0, 4);

	initcanvas();
	timestep();
}

function recurse(t){
	var newt = [];
	for (var i = 0; i < t.length; ++i) {
		if (t[i].ch == 'F') {
			newt.push(new node('F',
			t[i].alf, t[i].bet, t[i].gam,
			t[i].len*0.8));

			newt.push(new node('['));

			newt.push(new node(
			'F', 0, 0, t[i].gam-Math.PI/4, t[i].len*0.8));

			newt.push(new node(']'));

			newt.push(new node(
			'F', 0, 0, t[i].gam+Math.PI/4, t[i].len*0.8));

		} else {
			newt.push(new node(t[i].ch,
			t[i].alf, t[i].bet, t[i].gam,
			t[i].len));
		}
	}
	return newt;
}

function render(t){
	line([0, 0, 0, 1], [1, 0, 0, 1]);
	line([0, 0, 0, 1], [0, 1, 0, 1]);
	line([0, 0, 0, 1], [0, 0, 1, 1]);

	var turtle = {
		q: [0, 0, 0, 1],
		M: mat4id()};
	var Sq = [];
	var SM = [];
	for (var i = 0; i < t.length; ++i) {
		if (t[i].ch == 'F') {
			var T = mat4fromZYZ(t[i]);
			var dq = mat4apply(T, [0, t[i].len, 0, 1]);

			line(turtle.q, v4add(turtle.q, dq));
			turtle.q = v4add(turtle.q, dq);
			turtle.M = T;

		} else if (t[i].ch == '[') {
			Sq.push([turtle.q[0], turtle.q[1], turtle.q[2], 1]);
			SM.push(mat4mul(mat4id(), turtle.M));

		} else if (t[i].ch == ']') {
			turtle.q = Sq.pop();
			turtle.M = SM.pop();

		}
	}

}


// HTML canvas stuff
var world;
var context;
function initcanvas(){
	canvas = document.getElementById("world");
	context = canvas.getContext('2d');

	context.lineWidth = 2;

}

var camera = {
	z: 0.8,			// depth
	q: [5, 0, 5, 1],	// location
	d: v4unit([1, 0, 1, 1]),// direction vector
	u: [0, 1, 0, 1],	// up vector
	near: 1,
	far: 100
}
	
function project(q3d, cam){
	var x = v4dot(v4x(cam.u, cam.d), v4sub(q3d, cam.q));
	var y = v4dot(cam.u, v4sub(q3d, cam.q));
	var z = cam.z-v4dot(cam.d, v4sub(q3d, cam.q));

	if (z < cam.near || z > cam.far) { return null; }
	return [
		(1+cam.z/(cam.z+z)*x)/2*canvas.clientWidth,
		(1-cam.z/(cam.z+z)*y)/2*canvas.clientHeight
	];
}

function line(a, b){
	context.beginPath();
	var a2d = project(a, camera);
	var b2d = project(b, camera);
	if (a2d && b2d) {
		context.moveTo(a2d[0], a2d[1]);
		context.lineTo(b2d[0], b2d[1]);
		context.stroke();
	}
}

var thet = 0;
function timestep(){
	thet = thet + 0.005;

	// camera rotation.
	camera.q = [ 10*Math.sin(thet), 1, 10*Math.cos(thet), 1];
	camera.d = v4unit([ Math.sin(thet), 0, Math.cos(thet), 1 ]);

	// clear canvas & render new tree
	context.clearRect(0, 0, canvas.width, canvas.height);

	render(lindenmayer);

	window.requestAnimationFrame(timestep);
}
</script>

</head>
<body>

<div id = "container">
	<h2>TITLE</h2>

	<canvas id = "world" width = "720" height = "720"></canvas>

	<script>init();</script>

	<div><p>description.</p></div>

	<div id = "credits">
	J. Lok, [M] [yyyy].
	</div>

</div>


</body>

</html>
