<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8"/>
<link href = 'https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel = 'stylesheet' type = 'text/css'>
<style>
html, body {
	margin: 0; padding: 0;
	background-color: #343434;
	color: #666;

	font-family: 'open sans', sans-serif;
	font-size: 14px;
}
h2 { font-size: 18px; }

/*UI*/

#container {
	width: 720px;
	margin: 4px auto;
}
#credits{
	margin-top: 16px;
	font-size: 12px;
}

/* WORLD*/

#world {
	border: 1px #ccc none;/*dashed;*/

	margin: 4px auto;

	position: relative;

	width: 720px;
	height: 720px;

	/*overflow: hidden;*/
}

</style>

<script src = "../shared/three.min.js"></script>
<script src = "../shared/orbitcontrols.js"></script>
<script src = "../shared/v4.js"></script>
<script>

function integrate(q, v){
	q[0] = q[0]+v[0]*dt;
	q[1] = q[1]+v[1]*dt;
	q[2] = q[2]+v[2]*dt;
}

// LORENZ ATTRACTOR
function v_lorenz(q, v, p){
	v[0] = 0.6*(p[0]*(q[1]-q[0]));
	v[1] = 0.6*(q[0]*(p[2]-q[2])-q[1]);
	v[2] = 0.6*(q[0]*q[1]-p[1]*q[2]);
}
function lorenz(S){
	S.reset(); S.f = v_lorenz;

	// parameters
	S.parameters = [12, 8/3, 28];

	// initial conditions
	S.q = [0.001, 0, 0];
	S.v = [0, 0, 0];
	
	S.steps_per_seg = 4;
	S.segs_per_update = 16;

	// default viewing angle for maximum prettiness
	orbitcontrols.camera_fromqspherical({
	o: [10, 2.9, 14, 1], r: 88, t: 3.8, f: 0.9});
}

// ROESSLER ATTRACTOR
function v_roessler(q, v, p){
	v[0] = 2*(-q[1]-q[2]);
	v[1] = 2*(q[0]+p[0]*q[1]);
	v[2] = 2*(p[1]+q[2]*(q[0]-p[2]));
}
function roessler(S){
	S.reset(); S.f = v_roessler;

	S.parameters = [0.2, 0.2, 5.7];

	S.q = [-0.1, 0.5, -0.6];
	S.v = [0, 0, 0];

	S.steps_per_seg = 4;
	S.segs_per_update = 16;

	orbitcontrols.camera_fromqspherical({
	o: [2.1, 1.2, 9, 1], r: 42, t: 4.2, f: -0.15});
}

// THOMAS
function v_thomas(q, v, p){

	v[0] = 60*(Math.sin(q[1]/6)-p[0]*q[0]/6);
	v[1] = 60*(Math.sin(q[2]/6)-p[0]*q[1]/6);
	v[2] = 60*(Math.sin(q[0]/6)-p[0]*q[2]/6);
}
function thomas(S){
	S.reset(); S.f = v_thomas;

	S.parameters = [0.2];

	S.q = [0.1, 0, 0];
	S.v = [0, 0, 0];

	S.steps_per_seg = 4;
	S.segs_per_update = 16;

	orbitcontrols.camera_fromqspherical({
	o: [16, 3, 8, 1], r: 60, t: 0.1, f: 0.3});
}

// CHUA CIRCUIT
function v_chua(q, v, p){
	var x = q[0]/10, y = q[1]/10, z = q[2]/10;
	var m0 = -1.143, m1 = -0.714;

	var f = m1*x+(m0-m1)/2*(Math.abs(x+1)-Math.abs(x-1));
	v[0] = 20*p[0]*(y-x-f);
	v[1] = 20*p[1]*(x-y+z);
	v[2] = -20*p[2]*y;
}
function chua(S){
	S.reset(); S.f = v_chua;

	S.parameters = [15.6, 1, 28];

	S.q = [0.7, 0, 0];
	S.v = [0, 0, 0];

	S.steps_per_seg = 4;
	S.segs_per_update = 16;

	orbitcontrols.camera_fromqspherical({
	o: [0, -0, 0, 1], r: 70, t: 0.89, f: -0.34 });
}


var roster = [lorenz, roessler, thomas, chua];
var currnt = 0;

var max_segs_per_update = 72;
var max_time = 4096;
var dt = 0.002;
function Dynsys(){

	// parameters
	this.parameters = null;

	// system state
	this.q = [0, 0, 0];
	this.v = [0, 0, 0];

	this.f = null;

	this.age = 0;
	
	this.steps_per_seg = 8;
	this.segs_per_update = 12;
	this.visual_init();
	
	return this;
}
Dynsys.prototype.visual_init = function() {
	// THREE.js thingies
	var g = new THREE.BufferGeometry();
	g.addAttribute('position',
	new THREE.BufferAttribute(
		new Float32Array(max_time*max_segs_per_update*3),
		3));
	g.getAttribute('position').dynamic = true;


	var m = new THREE.LineBasicMaterial({
		color: 0xffffff, linewidth: 1});

	this.mesh = new THREE.Line(g, m);
	scene.add(this.mesh);

	// default viewing angle for maximum prettiness
	this.defaultview = {
		o: [0, 0, 0, 1],
		r: 100, t: 0, f: 0};

}
Dynsys.prototype.update = function(){
	for (var j = 0; j < this.segs_per_update; ++j) {

	var qpattr = this.mesh.geometry.getAttribute('position');
	var qarray = qpattr.array;

	// update location of traced particle
	for (var i = 0; i < this.steps_per_seg; ++i) {
		this.f(this.q, this.v, this.parameters);
		integrate(this.q, this.v);
	}

	// push a new vertice
	qarray[this.age*3  ] = this.q[0];
	qarray[this.age*3+1] = this.q[1];
	qarray[this.age*3+2] = this.q[2];
	
	qpattr.needsUpdate = true;
	this.mesh.geometry.setDrawRange(0, this.age);

	++this.age;

	}
}
Dynsys.prototype.reset = function() {
	this.age = 0;
	this.q = [0.001, 0, 0];
	this.v = [0, 0, 0];
}

var renderer, camera, scene;
var origin = new THREE.Vector3(0, 0, 0);

var orbitcontrols;

var D;

function init(){
	// set up renderer, camera, and scene
	renderer = new THREE.WebGLRenderer({
		canvas: document.getElementById("world"),
		antialias: true
	});
	renderer.setClearColor(0x363636);

	camera = new THREE.PerspectiveCamera(30,
		renderer.domElement.clientHeight/
		renderer.domElement.clientWidth,
		1, 1000);

	camera.up.set(0, 0, 1);
	camera.position.set(100, 100, 120);
	camera.lookAt(origin);

	scene = new THREE.Scene();

	// camera controls
	orbitcontrols = new Orbitcontrols(camera, renderer, scene);

	// system
	D = new Dynsys();
	roster[0](D);

	// handlers
	window.addEventListener("keydown", keydownHandler);

	// start timestepping
	timestep();

}
function keydownHandler(e){
	var pupd = false;
	if (e.which == 32 || e.which == 39) {
		// right arrow/space - next system
		next();
	} else if (e.which == 37) {
		// left arrow - last system
		prev();
	} else if (48 < e.which && e.which < 52) {
		D.parameters[e.which-49]*= 1.05;
		pupd = true;
	} else if (e.which == 81) {
		D.parameters[0]*= 0.95;
		pupd = true;
	} else if (e.which == 87) {
		D.parameters[1]*= 0.95;
		pupd = true;
	} else if (e.which == 69) {
		D.parameters[2]*= 0.95;
		pupd = true;
	}

	if (pupd) {
		console.log(D.parameters);
		D.reset();
		pupd = false;
	}
}

var t = 0;
function timestep(){
	t = t + dt;
	window.requestAnimationFrame(timestep);

	if (D.age >= max_time*D.segs_per_update) { next(); }
	D.update();

	orbitcontrols.update();


	renderer.render(scene, camera);


	
}
function next(){
	currnt = (currnt+1)%roster.length;
	roster[currnt](D);
}
function prev(){
	currnt = (currnt+roster.length-1)%roster.length;
	roster[currnt](D);
}


</script>

</head>
<body>

<div id = "container">
	<h2>ATTRACTORS</h2>

	<canvas id = "world" width = "720" height = "720"></canvas>
	<script> init(); </script>
	
	<div><p>
		Phase space trajectories of several notable dynamical systems (Lorenz, RÃ¶ssler, Thomas, and Chua, in order of presentation). Trajectories are integrated with a sympletic Euler scheme.	Written with javascript/WebGL.
	<ul>
		<li>LMB/WHEEL: move camera.</li>
		<li>LEFT/RIGHT/SPACE: go to previous/next system.</li>
		<li>1/Q,2/W,3/E: adjust system parameters.</li>
	</ul>
	</p></div>

	<div id = "credits">
	J. Lok, March 2017.
	</div>

</div>


</body>

</html>
